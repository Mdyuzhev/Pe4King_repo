# Pe4King

Pe4King представляет собой комплексный инструментарий для API-тестирования, объединяющий функции управления коллекциями запросов, генерации автотестов и анализа качества тестового кода. Проект включает расширение для Visual Studio Code и плагин для IntelliJ IDEA, обеспечивая поддержку двух основных IDE в экосистеме разработки.

## Назначение

Инструмент решает несколько задач в процессе тестирования API. Во-первых, он позволяет организовать работу с HTTP-запросами через систему коллекций, аналогичную Postman. Во-вторых, обеспечивает генерацию готового тестового кода на основе OpenAPI/Swagger спецификаций. В-третьих, предоставляет механизм оценки качества существующих тестов через модуль EVA.

## Компоненты проекта

Проект состоит из двух независимых компонентов, которые могут использоваться как вместе, так и по отдельности.

VS Code Extension находится в корневой директории и представляет собой расширение для Visual Studio Code. Исходный код расположен в директории src/, скомпилированная версия в dist/. Расширение написано на TypeScript.

IntelliJ IDEA Plugin располагается в директории idea_plugin/ и представляет собой плагин для семейства IDE от JetBrains. Написан на Kotlin, использует Gradle для сборки.

## Функциональные возможности

### Управление коллекциями

Система коллекций позволяет организовать API-запросы в иерархическую структуру. Каждая коллекция может содержать папки и запросы, поддерживается drag-and-drop для реорганизации. Запросы сохраняются в формате JSON и могут быть экспортированы для обмена между разработчиками.

Переменные окружения позволяют параметризовать запросы. Поддерживаются глобальные переменные, переменные коллекции и переменные окружения. Синтаксис подстановки использует двойные фигурные скобки: {{variable_name}}.

Pre-request скрипты выполняются перед отправкой запроса и позволяют динамически модифицировать параметры. Post-response скрипты выполняются после получения ответа и используются для извлечения данных и валидации. Скрипты пишутся на JavaScript.

### Test Runner

Встроенный раннер позволяет выполнять запросы и проверять ответы. Поддерживаются Postman-совместимые сниппеты для написания assertions. Результаты выполнения сохраняются в истории с возможностью повторного запуска.

Доступные сниппеты включают проверку статус-кода, наличия полей в JSON, соответствия значений, времени ответа и других параметров. Синтаксис сниппетов совместим с Postman, что упрощает миграцию существующих коллекций.

### Генерация тестов

На основе OpenAPI/Swagger спецификации инструмент генерирует готовый тестовый код. Поддерживаются три целевых формата.

pytest генерирует тесты на Python с использованием библиотеки requests. Каждый endpoint преобразуется в отдельный тест-метод с параметризацией по HTTP-методам.

REST Assured генерирует тесты на Java для использования с фреймворком REST Assured. Структура классов соответствует группировке endpoints по тегам в спецификации.

k6 генерирует скрипты для нагрузочного тестирования. Включает сценарии с различными профилями нагрузки и проверки SLA.

### EVA — анализ качества тестов

Модуль EVA (Evaluation of Verification Assets) выполняет статический анализ тестового кода и оценивает его качество по нескольким метрикам.

Oracle Depth определяет глубину проверок в тесте по шкале от L0 до L6. Уровень L0 означает отсутствие assertions, L1 проверяет только статус-код, L2 добавляет проверку существования ответа, L3-L4 проверяют поля ответа, L5-L6 включают проверку типов и бизнес-логики.

Детекция антипаттернов выявляет проблемные практики в тестовом коде: использование Thread.sleep(), пустые catch-блоки, copy-paste тесты, слабые matchers.

Система грейдов присваивает тестам оценку от S (отлично) до F (неудовлетворительно) на основе взвешенной суммы метрик. Отчёт включает конкретные рекомендации по улучшению.

### Интеграция с TestIT

Инструмент md2testit преобразует markdown-документацию ручного тестирования в формат Excel, совместимый с TestIT. Парсер распознаёт структуру документа с предусловиями, шагами тестирования и ожидаемыми результатами.

## Установка и сборка

### VS Code Extension

Для сборки расширения необходим Node.js версии 18 или выше. Выполните следующие команды в корневой директории проекта:

```
npm install
npm run compile
npm run package
```

Команда npm install устанавливает зависимости проекта. Команда npm run compile компилирует TypeScript в JavaScript. Команда npm run package создаёт .vsix файл для установки.

Для установки расширения откройте VS Code, перейдите в раздел Extensions, выберите пункт меню "Install from VSIX" и укажите путь к созданному .vsix файлу.

### IntelliJ IDEA Plugin

Для сборки плагина необходим JDK версии 17 или выше. Выполните следующие команды в директории idea_plugin:

```
./gradlew buildPlugin
```

На Windows используйте gradlew.bat вместо ./gradlew. Результат сборки появится в директории build/distributions в виде .zip архива.

Для установки плагина откройте IntelliJ IDEA, перейдите в Settings, затем в раздел Plugins, выберите "Install Plugin from Disk" и укажите путь к .zip архиву.

## Использование CLI-утилит

### EVA — анализ качества тестов

Скрипт eva-v2.js выполняет анализ тестовых файлов и выводит отчёт о качестве.

Анализ директории с тестами:
```
node scripts/eva-v2.js ./path/to/tests/
```

Анализ архива с тестами:
```
node scripts/eva-v2.js ./tests.zip
```

Вывод в формате JSON для интеграции с CI/CD:
```
node scripts/eva-v2.js ./tests/ --json
```

Скрипт поддерживает файлы Java (.java) и Python (.py). Анализ выполняется статически без запуска тестов.

### md2testit — конвертер для TestIT

Скрипт md2testit.js преобразует markdown-документы в Excel-файлы для импорта в TestIT.

```
node scripts/md2testit.js input.md output.xlsx
```

Если библиотека xlsx не установлена, скрипт создаст TSV-файл, который также открывается в Excel.

Для работы с xlsx установите зависимость:
```
npm install xlsx
```

## Структура директорий

```
Pe4King/
├── src/                        Исходный код VS Code расширения
│   ├── collections/            Модуль управления коллекциями
│   │   └── exporters/          Экспортёры коллекций
│   ├── core/                   Ядро приложения
│   ├── renderers/              Генераторы тестового кода
│   │   ├── postman/            Экспорт в формат Postman
│   │   ├── pytest/             Генератор pytest тестов
│   │   └── rest-assured/       Генератор REST Assured тестов
│   └── ui/                     Компоненты интерфейса
│       └── webview/            Веб-панели расширения
├── dist/                       Скомпилированный JavaScript
├── media/                      Иконки и графические ресурсы
├── scripts/                    CLI-утилиты
│   ├── eva-v2.js               Анализатор качества тестов
│   └── md2testit.js            Конвертер markdown в TestIT
├── test/                       Тесты расширения
│   └── fixtures/               Тестовые данные
├── idea_plugin/                IntelliJ IDEA плагин
│   ├── src/main/               Исходный код плагина (Kotlin)
│   ├── src/test/               Тесты плагина
│   └── gradle/                 Конфигурация Gradle
├── package.json                Конфигурация npm проекта
├── tsconfig.json               Конфигурация TypeScript
└── .vscodeignore               Исключения для сборки vsix
```

## Системные требования

Для VS Code расширения требуется Node.js версии 18 или выше и Visual Studio Code версии 1.80 или выше.

Для IntelliJ IDEA плагина требуется JDK версии 17 или выше и IntelliJ IDEA версии 2023.3 или выше.

CLI-утилиты требуют только Node.js версии 18 или выше.

## Лицензия

Proprietary
